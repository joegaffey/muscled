<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUlti-SCreen Layout EDitor</title>
    <style>
      body {
        margin: 0;
      }
      .loader {
        font-family: verdana;
        font-size: 24px;
        display: none;
        height: auto;
        width: 250px;
        position: absolute;
        top: calc(50% - 50px);
        left: calc(50% - 125px);
        text-align: center;
        padding: 30px 0;
        background-color: #222222;
        color: lightgray;
      }
    </style>
    <script
      async
      src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
    ></script>
    <script type="importmap">
      {
        "imports": {
          "three": "./lib/three.module.js",
          "orbitControls": "./lib/OrbitControls.js",
          "stlLoader": "./lib/STLLoader.js",
          "vrButton": "./lib/VRButton.js",
          "screen": "./screen.js"
        }
      }
    </script>
    <script type="text/javascript" src="./lib/dat.gui.min.js"></script>
  </head>
  <body>
    <div class="loader">
      Loading...
    </div>
    <script type="module">
      import * as THREE from 'three';
      import { OrbitControls } from 'orbitControls';
      import STLLoader from 'stlLoader';
      import Screen from 'screen';
      // import { VRButton } from 'vrButton';

      const gui = new dat.GUI();
      
      let loadingCount = 0;
      const loaderEl = document.querySelector('.loader');

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      
      // renderer.xr.enabled = true;
      // document.body.appendChild(VRButton.createButton(renderer));

      const controls = new OrbitControls(camera, renderer.domElement);
      
      const wireMaterial = new THREE.MeshBasicMaterial({
        color: 0x88ff88,
        transparent: true,
        opacity: 0.25,
      });
      
      const cdnPath = 'https://cdn.glitch.global/710b4225-853b-4ba5-bd3d-1a005f44407d/';
      
      const images = {
        'Project Cars 2': {
          left: cdnPath + 'racing1.jpg',
          middle: cdnPath + 'racing1.jpg',
          right: cdnPath + 'racing1.jpg',
        },
        'Project Cars': {
          left: cdnPath + 'pcars.jpg',
          middle: cdnPath + 'pcars.jpg',
          right: cdnPath + 'pcars.jpg',
        },
        'iRacing': {
          left: cdnPath + 'iracing.jpg',
          middle: cdnPath + 'iracing.jpg',
          right: cdnPath + 'iracing.jpg',
        },
        'Assetto Corsa': {
          left: cdnPath + 'ac1.jpg',
          middle: cdnPath + 'ac1.jpg',
          right: cdnPath + 'ac1.jpg',
        },
        'RFactor 2': {
          left: cdnPath + 'rfactor2_1.jpg',
          middle: cdnPath + 'rfactor2_1.jpg',
          right: cdnPath + 'rfactor2_1.jpg',
        },
        'Dirt Rally (Cockpit)': {
          left: cdnPath + 'dirtrally_cockpit4.jpg',
          middle: cdnPath + 'dirtrally_cockpit4.jpg',
          right: cdnPath + 'dirtrally_cockpit4.jpg',
        },
        'Dirt Rally (Bonnet)': {
          left: cdnPath + 'dirtrally_g44.jpg',
          middle: cdnPath + 'dirtrally_g44.jpg',
          right: cdnPath + 'dirtrally_g44.jpg',
        },
      };
            
      const sf = 0.75;

      // prettier-ignore
      const specs = { 
        '19" 4x3': { xAspect: 4, yAspect: 3, width: 19*sf, height:  19*sf/4*3, depth: 0.5, bezel: 0.5, fov: 1.35, xOffset: 0, yOffset: 0, angle: 0.9, spacing: 11.35, centerOffset: -5.9, floorHeight: 26.5, z: 16 },
        '24" 16x9': { xAspect: 16, yAspect: 9, width: 24*sf, height: 24*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 12.6, centerOffset: -8.4, floorHeight: 27, z: 18 },
        '27" 16x9': { xAspect: 16, yAspect: 9, width: 27*sf, height: 27*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 14.2, centerOffset: -9.55, floorHeight: 27.5, z: 18 },
        '29" 21x9': { xAspect: 21, yAspect: 9, width: 29*sf, height: 29*sf/21*9, depth: 0.5, bezel: 0.5, fov: 0.76, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 15.2, centerOffset: -10.1, floorHeight: 26.5, z: 18 },
        '32" 16x9': { xAspect: 16, yAspect: 9, width: 32*sf, height: 32*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 16.9, centerOffset: -11.1, floorHeight: 28, z: 16 },
        '34" 21x9': { xAspect: 21, yAspect: 9, width: 34*sf, height: 34*sf/21*9, depth: 0.5, bezel: 0.5, fov: 0.76, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 17.8, centerOffset: -12, floorHeight: 27.5, z: 20 },
        '40" 16x9': { xAspect: 16, yAspect: 9, width: 40*sf, height: 40*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 21, centerOffset: -14, floorHeight: 29, z: 17 },
        '42" 16x9': { xAspect: 16, yAspect: 9, width: 42*sf, height: 42*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 22, centerOffset: -14.6, floorHeight: 29, z: 17 },
        '43" 16x9': { xAspect: 16, yAspect: 9, width: 43*sf, height: 43*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 23, centerOffset: -15, floorHeight: 29, z: 17 },
        '43" 32x9': { xAspect: 32, yAspect: 9, width: 43*sf, height: 43*sf/32*9, depth: 0.5, bezel: 0.5, fov: 0.5, xOffset: 0, yOffset: 0, angle: 1.13, spacing: 23, centerOffset: -15, floorHeight: 27, z: 25 },
        '49" 16x9': { xAspect: 16, yAspect: 9, width: 49*sf, height: 49*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.2, spacing: 25, centerOffset: -17.6, floorHeight: 29.5, z: 15 },
        '49" 32x9': { xAspect: 32, yAspect: 9, width: 49*sf, height: 49*sf/32*9, depth: 0.5, bezel: 0.5, fov: 0.5, xOffset: 0, yOffset: 0, angle: 1.2, spacing: 25, centerOffset: -17.6, floorHeight: 27, z: 25 },
        '50" 16x9': { xAspect: 16, yAspect: 9, width: 50*sf, height: 50*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.2, spacing: 25.75, centerOffset: -17.6, floorHeight: 29.5, z: 15 },
        '55" 16x9': { xAspect: 16, yAspect: 9, width: 55*sf, height: 55*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.2, spacing: 28, centerOffset: -19.5, floorHeight: 30, z: 12 },
        '65" 16x9': { xAspect: 16, yAspect: 9, width: 65*sf, height: 65*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.2, spacing: 33, centerOffset: -23, floorHeight: 31.5, z: 10 },
        '75" 16x9': { xAspect: 16, yAspect: 9, width: 75*sf, height: 75*sf/16*9, depth: 0.5, bezel: 0.5, fov: 1, xOffset: 0, yOffset: 0, angle: 1.2, spacing: 38, centerOffset: -27, floorHeight: 32, z: 8 },
        '85" 16x9': { xAspect: 16, yAspect: 9, width: 85*sf, height: 85*sf/16*9, depth: 0.5, bezel: 0., fov: 1, xOffset: 0, yOffset: 0, angle: 1.2, spacing: 43, centerOffset: -30, floorHeight: 33.3, z: 7 },
      }

      const camTarget = [0, 15, 0];

      const cams = {
        leftShoulder: { pos: [-20, 25, 55], target: camTarget },
        rightShoulder: { pos: [20, 25, 55], target: camTarget },
        top: { pos: [0, 80, 20], target: [0, 0, 20] },
        driver: { pos: [0, 25, 35], target: [0, 25, 34.9] },        
      };
      setCamera(Object.values(cams)[0]);
      
      const defaultSize = '32" 16x9';
      const currentSpec = {}
      setCurrentSpec(specs[defaultSize]);
     
      const screen1 = new Screen(currentSpec, images['Project Cars 2'].left, 'left');
      const screen2 = new Screen(currentSpec, images['Project Cars 2'].middle, 'middle');
      const screen3 = new Screen(currentSpec, images['Project Cars 2'].right, 'right');
      
      scene.add(screen1);
      scene.add(screen2);
      scene.add(screen3);

      let screens = {
        size: defaultSize,
        wireframe: false,
        single: false,
        image: images
      };
      
      const displayGUI = gui.addFolder('Display');
      displayGUI.add(currentSpec, 'fov', 0.1, 10, 0.01).name('Virtual FoV').onChange((value) => { setSpecProp('fov', value); });
      displayGUI.add(currentSpec, 'xOffset', -1, 1, 0.01).name('X Offset').onChange((value) => { setSpecProp('xOffset', value); });
      displayGUI.add(currentSpec, 'yOffset', -1, 1, 0.01).name('Y Offset').onChange((value) => { setSpecProp('yOffset', value); });      
      displayGUI.add(screens, 'image', Object.keys(images)).name('Game').onChange((value) => { setImage(value); });      
            
      const screenGUI = gui.addFolder('Screens');
      screenGUI.add(screens, 'single').name('Single');
      screenGUI.add(screens, 'size', Object.keys(specs)).name('Size').onChange((value) => { setScreenSpec(specs[value]); });
      screenGUI.add(currentSpec, 'depth', 0, 3, 0.01).name('Depth').onChange((value) => { setSpecProp('depth', value); });
      screenGUI.add(currentSpec, 'angle', 0, Math.PI/2, 0.01).name('Sides Angle').onChange((value) => { setSpecProp('angle', value); });
      screenGUI.add(currentSpec, 'spacing', 0, 80, 0.01).name('Spacing').onChange((value) => { setSpecProp('spacing', value); });
      screenGUI.add(currentSpec, 'floorHeight', 0, 50, 0.01).name('Floor Height').onChange((value) => { setSpecProp('floorHeight', value); });
      screenGUI.add(currentSpec, 'z', -10, 40, 0.01).name('Distance').onChange((value) => { setSpecProp('z', value); });
      screenGUI.add(currentSpec, 'centerOffset', -30, 20, 0.01).name('Center Offset').onChange((value) => { setSpecProp('centerOffset', value); });
      screenGUI.add(currentSpec, 'bezel', 0, 5, 0.01).name('Bezel').onChange((value) => { setSpecProp('bezel', value); });
      screenGUI.add(screens, 'wireframe').name('Wireframe');
      
      const camGUI = gui.addFolder('Camera');
      
      const camSelect = { view: Object.keys(cams)[0] };
      camGUI.add(camSelect, 'view', Object.keys(cams)).name('View').onChange((value) => {
        setCamera(cams[value]);
      });
      camGUI.add(camera, 'fov', 20, 120).name('FoV').onChange((value) => {
        camera.updateProjectionMatrix();
      });
      
      const camPosGUI = camGUI.addFolder('Position');
      camPosGUI.add(camera.position, 'x', -100, 100).name('X');
      camPosGUI.add(camera.position, 'y', -100, 100).name('Y');
      camPosGUI.add(camera.position, 'z', -100, 100).name('Z');
      
      const camRotGUI = camGUI.addFolder('Rotation');
      camRotGUI.add(camera.rotation, 'x', -Math.PI, Math.PI).name('Z');
      camRotGUI.add(camera.rotation, 'y', -Math.PI, Math.PI).name('Y');
      camRotGUI.add(camera.rotation, 'z', -Math.PI, Math.PI).name('Z');

      const rigModelPath = cdnPath + 'rig3.stl';
      let rig = null;

      const stlLoader = new STLLoader();
      startLoad();
      stlLoader.load(
        rigModelPath,
        (geometry) => {
          setTimeout(() => { endLoad(); }, 1000);
          const mesh = new THREE.Mesh(geometry, wireMaterial);
          mesh.rotation.x = -Math.PI / 2;
          mesh.rotation.z = Math.PI / 2;
          mesh.position.x = 12;
          mesh.position.z = 40;
          scene.add(mesh);
          rig = mesh;
          const rigGUI = gui.addFolder('Rig');
          rigGUI.add(rig, 'visible').name('Visible');
          const rigPosGUI = rigGUI.addFolder('Position');
          rigPosGUI.add(rig.position, 'x', -100, 100).name('X');
          rigPosGUI.add(rig.position, 'y', -100, 100).name('Y');
          rigPosGUI.add(rig.position, 'z', -100, 100).name('Z');          
        },
        (xhr) => {
          loaderEl.innerHTML = Math.round((xhr.loaded / xhr.total) * 100) + '% LOADED';
        },
        (error) => {
          loaderEl.innerHTML = 'Error loading model.'
          setTimeout(() => { endLoad(); }, 5000);
          console.log(error);
        }
      );      
      
      function setImage(name) {
        screen1.setImage(images[name].left);
        screen2.setImage(images[name].middle);
        screen3.setImage(images[name].right);
      }
      
      function setSpecProp(name, value) {
        currentSpec[name] = value;
        setScreenSpec(currentSpec);
      }
               
      function setScreenSpec(spec) {
        setCurrentSpec(spec);
        gui.updateDisplay();
        displayGUI.updateDisplay();
        screenGUI.updateDisplay();
        screen1.setSpec(currentSpec);
        screen2.setSpec(currentSpec);
        screen3.setSpec(currentSpec);
        document.activeElement.blur();
      }
      
      function setCurrentSpec(spec) {
        Object.keys(spec).forEach(key => {
          currentSpec[key] = spec[key];
        });
      }
      
      function startLoad() {
        loadingCount++;
        loaderEl.style.display = 'block';
      }
      
      function endLoad() {
        loadingCount--;
        if(loadingCount === 0)
          loaderEl.style.display = 'none';
      }

      function setCamera(cam) {
        camera.position.set(...cam.pos);
        controls.target.set(...cam.target);
        controls.update();
        
        gui.updateDisplay();
        document.activeElement.blur();
      }
      
      function animate() {
        screen2.position.set(
          0,
          currentSpec.floorHeight,
          currentSpec.z + currentSpec.centerOffset
        );
        if (!screens.wireframe)
          screen2.material = screen2.defaultMaterial;
        
        if(!screens.single) {    
          screen1.visible = true;
          screen3.visible = true;
        
          screen1.rotation.y = currentSpec.angle * -1;
          screen3.rotation.y = currentSpec.angle;

          screen1.position.set(currentSpec.spacing, currentSpec.floorHeight, currentSpec.z);
          screen3.position.set(-currentSpec.spacing, currentSpec.floorHeight, currentSpec.z);

          if (!screens.wireframe) {
            screen1.material = screen1.defaultMaterial;
            screen3.material = screen3.defaultMaterial;
          } 
          else 
            screen1.material = screen2.material = screen3.material = wireMaterial;
          
        }
        else {
          screen1.visible = false;
          screen3.visible = false;
        }
        
        renderer.render(scene, camera);
      }
      
      renderer.setAnimationLoop(() => {
        animate();
      });

      window.addEventListener('resize', onWindowResize, false);

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    </script>
  </body>
</html>